
\timing
-- Device = PVLINK, BATTERY, INVERTER, BEACON, ICM

-- RCP State Lookup Table
select * from status.rcp_state;

-- Device Shadow -> last state of a device in the cloud
select * from status.device_shadow s
join status.rcp_state r on r.state_code = s.st
where st between x'7000'::int and x'7FFF'::int
and host_rcpn!=''
order by s.st desc, timestamp_utc desc, device_type

-- State Change Events -> only where the RCP state has change
select state_text, * from status.legacy_status_state_change ls, status.rcp_state r
where device_id = '000100070F9E' 
and ls.st = r.state_code
and timestamp_utc > NOW() - INTERVAL '7 day'
order by timestamp_utc desc;

-- Status Update -> All Events every 1 minute per device
select state_text, * from status.legacy_status ls, status.rcp_state r
where device_id = '000100070F9E' 
and ls.st = r.state_code
and timestamp_utc between '2020-12-09' and '2020-12-11'
order by timestamp_utc desc;





















-- solar ratio

with batteries as (
  
SELECT count(batteries) as batteries
FROM
    (SELECT host_rcpn,
            count(device_id) as batteries
     FROM status.device_shadow
     WHERE device_type='BATTERY'
         AND host_rcpn!=''
     GROUP BY host_rcpn) AS b

),
inverters as (

SELECT sum(inverters) as inverters
FROM
    (SELECT count(host_rcpn) AS inverters
     FROM status.device_shadow
     WHERE device_type='INVERTER'
         AND host_rcpn!=''
     GROUP BY host_rcpn) as i 
),
solar_only_ratio as (
select 
  (select batteries from batteries)::real /
  (select inverters from inverters)::real as ratio
)

select * from solar_only_ratio

-- lag

with errors as (

SELECT device_id,
       host_rcpn,
       device_type,
       timestamp_utc,
       st,
       to_hex(st)
FROM status.device_shadow
WHERE host_rcpn = ANY ('{ 000100070B7A, 0001000712A0, 000100071B22, 000100071514, 000100071DC5, 000100071F7A, 0001000710E0, 000100070FE5, 000100071F51, 000100071235, 000100070F10, 000100071526, 0001000717C4, 000100070A71, 000100071B19, 00010007252F, 000100070F6A, 000100070AF4, 00010007117E, 0001000716ED, 000100071D78, 00010007160F, 0001000707D7, 00010007196F, 0001000706DC, 000100071566, 000100070738, 000100070644, 000100072451, 0001000715A5, 000100072183, 000100071445, 000100070AD2, 0001000701C2, 00010007286E, 0001000710BA, 0001000721E9, 000100070A0C, 000100072915, 000100070B70, 000100072784, 0001000717CA, 00010007149B, 000100071E2C, 0001000712E3, 000100070B6D, 000100071177, 00010007185D, 00010007045D, 000100071A81, 000100070881, 000100071C02, 0001000723CD, 000100072058, 000100070FC1, 000100072D5B, 0001000728A8, 000100071896, 000100071F81, 00010007105A, 0001000716E7, 000100071664, 000100071465, 000100071C29, 000100071990, 0001000710E6, 000100071980, 000100070746, 0001000710A1, 000100071F3E, 00010007203C, 000100070BCC, 000100071CC0, 000100070650, 0001000724A4, 000100070B21, 000100070663, 0001000704A1, 0001000724A8, 000100071B41, 000100071517, 000100070B18, 000100072264, 000100070557, 000100070731, 000100072E86, 00010007027F, 0001000714BB, 000100070518, 0001000717A8, 000100072738, 000100071D8F, 000100070884, 0001000719EF, 000100073242, 000100072EBC, 0001000716D6, 0001000717B2, 00010007325D, 00010007172D, 00010007041B, 000100072794, 000100071950, 000100071663, 000100070A97, 000100070690, 0001000720AF, 000100071984, 000100071B2A, 000100070BA3, 000100072395, 000100071860, 00010007175D, 00010007162C, 000100072C14, 000100071E54, 000100071D80, 000100071F39, 000100071554, 000100071ED0, 00010007083C, 000100071E8F, 000100070D44, 00010007106E, 000100070FDA, 000100071CEF, 0001000721E6, 000100070FE0, 000100071B0E, 0001000712B0, 000100071AD9, 0001000722AC, 000100071D90, 000100072CE6, 0001000724C3, 000100071DAB, 000100070A89, 00010007205C, 0001000722A2, 000100071D23, 000100071E1C, 0001000719E3, 000100070E6C, 000100072332, 000100071842, 00010007290A, 0001000718E3, 000100070C2A, 000100072161, 000100072590, 000100070A31, 0001000715D3, 00010007147B, 0001000720F2, 000100071BD9, 00010007197A, 000100071708, 000100071255, 0001000723E5, 000100071926, 000100070BD7, 000100070A27, 0001000704E7, 0001000710B6, 000100072820, 0001000727BF, 0001000718D0, 000100070627, 000100071236, 000100071621, 000100070B4A, 0001000717A9, 000100070C91, 000100071643, 000100071769, 000100070F42, 00010007222C, 000100070824, 000100071EC5, 0001000712D2, 000100072111, 000100071ACA, 00010007105F, 000100070EC5, 000100070AF5, 000100071592, 000100070FB8, 000100071571, 0001000728D3, 0001000729A3, 000100070B40, 000100070B59, 00010007140B, 0001000700A1, 00010007174A, 0001000721AB, 000100072043, 000100072C05, 0001000714E0, 00010007054C, 000100071F14, 00010007084A, 000100071E87, 0001000725E5, 000100071942, 000100070797, 0001000717A1, 0001000716BB, 000100071638, 00010007051C, 0001000709F1, 0001000707E6, 000100070BFD, 000100071690, 00010007211A, 000100071A29, 000100071616, 000100070F52, 000100070B33, 000100071F16, 0001000705E8, 000100071F6B, 000100070765, 000100071D27, 0001000718F0, 0001000719AA, 00010007143A, 00010007256C, 000100071A0E, 000100071DBD, 0001000712A9, 000100071421, 000100070748, 00010007250A, 0001000720FE, 000100071F92, 000100071618, 000100070669, 000100072254, 00010007126B, 000100071CD8, 000100072535, 000100071C67, 000100071B3D, 00010007165F, 000100070D5B, 00010007047C, 000100070D54, 000100071A63, 0001000708E0, 000100071EBE, 000100070D0A, 0001000711DF, 00010007147E, 0001000714D9, 00010007224C, 0001000710B7, 000100070C30, 0001000708F0, 000100070D6F, 00010007251E, 00010007170D, 00010007184B, 00010007043B, 000100071507, 000100071B15, 000100071A6B, 000100070C15, 0001000718AE, 00010007169B, 0001000721CD, 000100071DE1, 0001000728C5, 00010007095F, 000100070F44, 000100070C61, 00010007123C, 000100071D79, 000100070FE8, 000100071F44, 000100071067, 0001000718B9, 000100070C29, 00010007291A, 000100072E2B, 00010007183D, 000100070B16, 00010007223A, 000100070A25, 000100070BB7, 00010007148B, 00010007196E, 000100071FFF, 0001000718DC, 000100071527, 00010007156C, 000100070EF0, 000100072648, 00010007192B, 0001000721DF, 000100070C34, 000100071008, 000100070F5E, 000100071A73, 00010007162E, 000100071431, 000100072E3E, 000100071195, 000100071ABB, 000100071433, 0001000718C9, 00010007209C, 0001000718EC, 00010007078F, 000100072802, 000100070A8C, 000100071B67, 00010007159E, 000100071C19, 00010007126D, 000100072562, 0001000715AD, 000100072458, 000100070572, 000100070728, 000100072139, 000100070F8A, 00010007106B, 000100072647, 000100070735, 0001000724D1, 000100071400, 00010007123F, 0001000705B0, 0001000702E0, 000100071420, 000100071D05, 000100071FB3, 0001000707C1, 000100071B4C, 0001000727EA, 0001000712E5, 000100071610, 000100071B58, 00010007242D, 000100071EE4, 000100070EAA, 00010007086B, 000100071AD7, 000100071CA2, 000100071506, 000100070480, 000100073274, 000100071B9D, 0001000708BC, 0001000719A0, 0001000714F2, 00010007151D, 0001000721B3, 0001000726F1, 000100071DFE, 000100070F35, 000100071CD7, 000100070CAD, 000100070664, 000100070AC1, 0001000720E1, 000100070B1F, 000100071595, 000100071899, 000100072900, 00010007187A, 00010007187E, 000100070CAA, 000100070B07, 00010007161E, 000100071AE9, 000100070D2C, 000100072136, 000100070656, 0001000717BD, 0001000719EC, 000100070867, 00010007158C, 000100071939, 0001000712AA, 000100071794, 000100071556, 000100072742, 00010007143F, 000100071A49, 000100071F2D, 000100071823, 000100071BB7, 00010007265B, 00010007023B, 0001000716A6, 000100071F5E, 000100071A67, 00010007205B, 000100071A5F, 00010007215C, 000100070751, 0001000707D2, 000100071AD5, 000100070C2E, 000100070499, 00010007047F, 0001000705BA, 000100072808, 000100070D88, 000100070F15, 000100070EDA, 000100071CB6, 000100071C8D, 000100071BCE, 000100071696, 000100072F6A, 00010007163D, 000100070ADF, 000100070C0E, 00010007140D, 000100071E20, 000100070C7F, 0001000715DA, 0001000712C5, 000100071A7F, 00010007093F, 0001000725C4, 000100072074, 000100070D96, 00010007158E, 000100071F98, 0001000705F6, 0001000706FB, 000100071C5A, 0001000719BB, 000100071723, 000100071A33, 0001000714B0, 00010007071A, 000100070B5F, 000100070B91, 00010007040D, 000100071BF9, 0001000716F0, 000100070378, 000100071A2A, 000100072508, 000100071947, 000100071B4D, 00010007103C, 000100071DA0, 00010007260A, 000100070B04, 00010007180A, 000100070B5C, 0001000705B8, 00010007058D, 000100071DC1, 000100071E11, 000100070D94, 0001000709F3, 0001000714B2, 000100070E69, 0001000728AC, 0001000706E1, 00010007194E, 000100072035, 000100071E74, 000100070C75, 000100072B2B, 00010007200D, 000100070C66, 000100070B5A, 000100071C09, 0001000725A5, 00010007117A, 0001000719D3, 000100071C0B, 0001000706A2, 0001000707B6, 000100071E13, 000100071E7C, 000100071979, 000100071776, 000100071A50, 000100070161, 00010007125A, 000100071978, 0001000719B9, 000100070E22, 0001000707B5, 000100070BC3, 00010007219F, 000100072497, 000100072F8E, 000100071C23, 000100071AE7, 000100071C39, 000100071F59, 000100071BA2, 0001000725D7, 000100070C4C, 000100070291, 000100071D33, 0001000716F2, 000100070855, 000100071D50, 0001000717C0, 000100070442, 000100070623, 0001000721C4, 000100071488, 0001000706E0, 000100071252, 00010007214C, 000100070EA3, 000100070EBC, 000100071B49, 000100071698, 0001000711C1, 000100070444, 000100070C39, 000100071ADB, 000100071738, 00010007021E, 000100070230, 000100070F87, 000100071156, 000100070F27, 000100070B0D, 0001000718D9, 0001000702DE, 000100071E02, 0001000702D6, 0001000703A3, 00010007057D, 000100072448, 000100071E91, 0001000721C2, 00010007204E, 00010007077A, 000100071278, 000100070459, 0001000729EC, 000100071064, 00010007047D, 000100070B8E, 00010007190C, 000100070D09, 000100070F2C, 000100070000, 0001000705F3, 000100071F35, 000100071BAD, 0001000716C4, 0001000712B8, 0001000729D3, 0001000708C6, 0001000715DE, 000100071ABE, 000100071C08, 000100070725, 000100070C23, 0001000707E3, 000100071DAE, 000100071A3F, 0001000724CC, 000100072393, 000100071B96, 000100072830, 000100070CD6, 00010007188C, 0001000728B2, 000100070603, 000100070E94, 000100070643, 0001000714B6, 000100070F9E, 00010007069D, 000100070F88, 0001000712E4, 00010007234F, 000100070B8D, 0001000717EF, 000100071170, 000100071E55, 00010007194C, 000100070853, 000100071ED7, 0001000715B7, 0001000714E3, 000100071F67, 0001000721D4, 000100072D8A, 0001000710FC, 000100070CD5, 000100070C64, 000100070909, 000100070E4E, 000100071E27, 0001000717D9, 0001000714DF, 0001000716DE, 000100071100, 000100072226, 00010007163F, 0001000721FC, 000100070369, 000100071DDE, 000100070545, 000100070B0F, 0001000714ED, 000100071492, 0001000720E5, 00010007285E, 000100072739, 000100071B9C, 000100071203, 000100071B6E, 000100071BFB, 0001000720A0, 000100071B75, 000100072203, 000100070730, 00010007078E, 000100070F95, 000100070FD1, 000100072DDD, 000100070961, 000100070C7A, 000100070BEA, 000100071FB8, 000100072488, 000100071789, 000100072E1D, 000100072621, 0001000708A1, 000100071EF8, 0001000720BF, 000100071790, 000100071E9B, 000100071DCB, 000100071C4D, 0001000706EB, 000100070D30, 000100071161, 000100071BF1, 000100070942, 0001000701E2, 000100072148, 000100071267, 0001000709DB, 000100072023, 000100071E37, 00010007106A, 0001000703ED, 00010007091C, 0001000718EB, 000100071924, 0001000717DD, 000100072024, 000100071F6C, 0001000707B0, 000100073086, 000100071BBD, 000100071D4B, 000100071500, 000100071B7D, 000100070D7E, 000100071E1F, 000100072239, 000100072713, 000100070866, 000100070B79, 0001000722D3, 0001000708AA, 00010007290E, 00010007102C, 00010007208B, 000100070AE7, 000100070321, 0001000706F3, 000100072FA4, 000100071C5E, 0001000718C3, 0001000715FC, 000100070235, 000100071141, 000100070E49, 0001000728FE, 000100072922, 000100070703, 000100070B1E, 000100071B1F, 000100071802, 00010007110D, 000100070DBD, 000100070F4E, 0001000728EF, 0001000728BB, 000100071CED, 0001000704D0, 0001000719E7, 000100070C7D, 000100072079, 000100070AEE, 000100071D0C, 0001000709C4, 000100071C28, 0001000718B2, 000100071557, 000100070DAB, 000100071D6F, 0001000710FF, 000100072222, 00010007153B, 000100070C18, 00010007275B, 0001000720D0, 000100071C8A, 0001000715DD, 000100070CF4, 0001000721B7, 0001000714B3, 00010007042E, 000100071494, 000100071D62, 000100072013, 00010007264A, 000100071422, 000100071E33, 0001000703B2, 0001000717B9, 000100071A6A, 0001000722ED, 000100070938, 00010007274D, 0001000716AA, 00010007162D, 000100071CCE, 000100070AFB, 0001000727FA, 000100071739, 00010007180E, 0001000710BC, 0001000711FB, 000100071863, 000100072EAB, 0001000715F4, 0001000706F6, 0001000714B1, 00010007171E, 00010007148D, 0001000707BD, 0001000708CB, 000100070917, 000100072F40, 000100071E5E, 0001000726E6, 0001000701D5, 000100070B85, 000100070622, 000100071BFA, 000100070AA8, 0001000704AF, 00010007160E, 000100071F71, 000100070655, 000100070AC2, 00010007094D, 000100070372, 00010007101B, 000100071A3E, 00010007321C, 000100071110, 0001000728D9, 000100071DB1, 000100070B6C, 0001000716F6, 000100070F85, 000100070DC4, 000100070D48, 000100071C25, 000100072668, 000100070BF9, 000100070C9F, 000100072098, 000100071CDA, 000100071E70, 0001000724EB, 000100071179, 000100071953, 000100071668, 000100070357, 000100072DF2, 00010007220F, 000100071C0A, 000100070E72, 000100071126, 000100070D69, 000100071DD7, 000100072771, 000100070A98, 000100072339, 000100070300, 000100071B1B, 0001000720CD, 000100072634, 00010007171A, 00010007109E, 000100070F83, 0001000707A8, 000100071051, 0001000707FA, 00010007042A, 000100070B17, 000100071795, 000100071627, 000100071925, 000100071943, 000100071D67, 00010007035B, 000100071005, 0001000727B4, 00010007290B, 00010007159B, 0001000708B5, 000100071D17, 000100070D19, 000100070F45, 000100071C59, 00010007188E, 00010007218D, 000100073292, 000100071C18, 00010007092D, 0001000703A9, 00010007122C, 000100070EFB, 000100071153, 00010007103A, 000100070621, 000100071C88, 000100071F50, 000100070888, 0001000720F3, 000100071DF5, 000100072B8D, 0001000706D8, 000100070366, 00010007197B, 0001000716A3, 000100071584, 0001000715D5, 0001000705BE, 000100071F4E, 0001000702EC, 000100071F3A, 000100070921, 000100070E9F, 0001000718AD, 00010007241F, 000100071486, 000100070E74, 00010007150F, 0001000724C9, 00010007096C, 000100071C5F, 0001000703D6, 0001000723AF, 0001000721B6, 000100070BD2, 0001000708A9, 000100070BC2, 00010007212C, 000100071CF7, 00010007145A, 00010007277C, 00010007259A, 000100070D60, 000100070696, 00010007155B, 000100070F59, 000100072559, 000100070DCC, 000100070D90, 000100072063, 000100071454, 00010007069A, 0001000721E2, 000100071682, 0001000707CF, 000100071254, 0001000718BF, 000100071688, 00010007189C, 000100072869, 000100070661, 000100071FD0, 000100070C09, 000100071180, 0001000701C0, 00010007115B, 000100072918, 0001000719AB, 000100072DDB, 0001000715F7, 000100070D2D}') 
    AND st BETWEEN x'7000'::int AND x'7FFF'::int
ORDER BY timestamp_utc DESC
)


SELECT timestamp_utc,
       device_id,
       st,
       to_hex(st),
       to_hex(LAG(st) OVER (PARTITION BY device_id
                            ORDER BY timestamp_utc)) AS previous_st,
       timestamp_utc - LAG(timestamp_utc) OVER (PARTITION BY device_id
                                                ORDER BY timestamp_utc) AS duration
FROM status.legacy_status_state_change
WHERE device_id IN
        (SELECT device_id
         FROM errors)
    AND timestamp_utc > NOW() - INTERVAL '7 day'
ORDER BY device_id,
         timestamp_utc DESC;

